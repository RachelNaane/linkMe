name: Docker Image CI

on:
  push:
    branches: [ "main" ]

permissions:
 id-token: write
 
jobs:
  CI:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Build Docker image
      run: docker build . --file Dockerfile --tag app
      
    #- name: E2E test
     # run: |
      #  export APP_IMAGE=app
       # docker compose up -d
        #chmod +x ./tests/e2e-test.sh
        #./tests/e2e-test.sh localhost:80
    
    - name: Git Semantic Version
      id: version
      uses: PaulHatch/semantic-version@v5.0.3
      with:
        tag_prefix: ""
        version_format: "${major}.${minor}.${patch}"
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: arn:aws:iam::752620938895:role/linkme-github-actions-role
        aws-region: eu-west-3
    
    - name: Publish image to ECR
      run: |
        aws ecr get-login-password --region eu-west-3 | docker login --username AWS --password-stdin 752620938895.dkr.ecr.eu-west-3.amazonaws.com
        docker tag app:latest 752620938895.dkr.ecr.eu-west-3.amazonaws.com/linkme:${{ steps.version.outputs.version_tag }}
        docker push 752620938895.dkr.ecr.eu-west-3.amazonaws.com/linkme:${{ steps.version.outputs.version_tag }}
      
